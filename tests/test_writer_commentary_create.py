import os
import sys
from importlib import import_module

import pytest


@pytest.fixture
def app_client(monkeypatch, tmp_path):
    """Flask test client with isolated SQLite DB and skipped API handshakes."""
    repo_root = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
    backend_root = os.path.join(repo_root, "loan-army-backend")
    if backend_root not in sys.path:
        sys.path.insert(0, backend_root)

    db_file = tmp_path / "test.sqlite"
    monkeypatch.setenv("FLASK_ENV", "production")
    monkeypatch.setenv("SQLALCHEMY_DATABASE_URI", f"sqlite:///{db_file}")
    monkeypatch.setenv("SECRET_KEY", "test-secret")
    monkeypatch.setenv("ADMIN_API_KEY", "test-admin-key")
    monkeypatch.setenv("SKIP_API_HANDSHAKE", "1")
    monkeypatch.setenv("API_USE_STUB_DATA", "true")
    monkeypatch.delenv("ADMIN_IP_WHITELIST", raising=False)

    sys.modules.pop("src.main", None)
    main = import_module("src.main")

    app = main.app
    db = main.db
    app.config.update(TESTING=True)

    with app.app_context():
        db.drop_all()
        db.create_all()

    with app.test_client() as client:
        yield app, client, db, main


def _user_token(app, email):
    from src.routes.api import _user_serializer

    with app.app_context():
        serializer = _user_serializer()
        return serializer.dumps({"email": email, "role": "journalist"})


def _seed_journalist(db, UserAccount, email, display_name, is_journalist=True):
    user = UserAccount(
        email=email,
        display_name=display_name,
        display_name_lower=display_name.lower(),
        is_journalist=is_journalist,
        can_author_commentary=is_journalist,
    )
    db.session.add(user)
    db.session.flush()
    return user


def _seed_team(db, Team, team_id=33, name="Manchester United"):
    team = Team(
        team_id=team_id,
        name=name,
        country="England",
        season=2025,
        newsletters_active=True,
    )
    db.session.add(team)
    db.session.flush()
    return team


def test_writer_can_create_player_commentary_with_string_player_id(app_client):
    app, client, db, main = app_client
    from src.models.league import UserAccount, Team

    with app.app_context():
        writer = _seed_journalist(db, UserAccount, "writer@example.com", "WriterOne")
        team = _seed_team(db, Team, team_id=33)
        from src.models.league import JournalistTeamAssignment
        db.session.add(JournalistTeamAssignment(user_id=writer.id, team_id=team.id))
        db.session.commit()
        token = _user_token(app, writer.email)
        team_id = team.id

    payload = {
        "team_id": team_id,
        "player_id": "284361",  # string on purpose (was causing type error)
        "commentary_type": "player",
        "title": "Match notes",
        "content": "<p>Solid outing</p>",
        "week_start_date": "2025-11-24",
        "week_end_date": "2025-11-30",
    }

    resp = client.post(
        "/api/writer/commentaries",
        json=payload,
        headers={"Authorization": f"Bearer {token}"},
    )

    assert resp.status_code == 201, resp.get_data(as_text=True)
    data = resp.get_json()
    assert data["player_id"] == 284361
