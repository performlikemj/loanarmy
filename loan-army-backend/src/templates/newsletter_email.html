<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or 'Academy Pipeline Update' }}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Monochrome email layout tuned for broad client support */
    body {
      margin: 0;
      padding: 0;
      background: #040404;
      color: #ffffff;
    }

    .wrapper {
      width: 100%;
      table-layout: fixed;
      background: #040404;
      padding: 24px 0;
    }

    .main {
      width: 100%;
      max-width: 680px;
      margin: 0 auto;
      background: #111111;
      border: 1px solid #303030;
      border-radius: 10px;
      overflow: hidden;
    }

    .content {
      padding: 28px 26px 32px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: #f0f0f0;
      line-height: 1.55;
    }

    .brand {
      font-size: 13px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #bebebe;
      margin-bottom: 18px;
    }

    h1 {
      font-size: 26px;
      margin: 0 0 12px;
      color: #ffffff;
    }

    .meta {
      font-size: 13px;
      color: #c9c9c9;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-bottom: 18px;
    }

    .divider {
      width: 48px;
      height: 2px;
      background: #ffffff;
      margin: 10px 0 22px;
    }

    .summary {
      font-size: 16px;
      color: #f5f5f5;
      margin: 12px 0 22px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 0 12px;
    }

    .title-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      background: #1f1f1f;
      display: block;
    }

    .highlights {
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 16px 18px;
    }

    .highlights strong {
      display: block;
      font-size: 15px;
      letter-spacing: 1px;
      margin-bottom: 6px;
      text-transform: uppercase;
      color: #ffffff;
    }

    .highlights ul {
      margin: 0;
      padding-left: 18px;
      color: #e6e6e6;
    }

    h2 {
      font-size: 19px;
      margin: 26px 0 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #f8f8f8;
    }

    .item {
      background: #0a0a0a;
      border: 1px solid #262626;
      border-radius: 8px;
      padding: 14px 16px 16px;
      margin-bottom: 12px;
    }

    .item-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .player-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .player-photo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      background: #1f1f1f;
      display: block;
    }

    .player {
      font-weight: 600;
      font-size: 15px;
      color: #ffffff;
    }

    .loan-team {
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #b5b5b5;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .team-logo {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
      background: #1f1f1f;
      display: block;
    }

    .opponent-logo {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      background: #1f1f1f;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .match-row {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #2a2a2a;
    }

    .match-row:last-child {
      border-bottom: none;
    }

    .match-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .match-opponent {
      font-weight: 600;
      font-size: 13px;
      color: #ffffff;
    }

    .match-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .match-result {
      font-weight: 700;
      font-size: 13px;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .match-result.win {
      background: #166534;
      color: #86efac;
    }

    .match-result.draw {
      background: #4b5563;
      color: #d1d5db;
    }

    .match-result.loss {
      background: #991b1b;
      color: #fca5a5;
    }

    .matches-section {
      margin: 12px 0;
      padding: 10px;
      background: #0f1419;
      border-radius: 6px;
    }

    .matches-header {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stats {
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      color: #d9d9d9;
      margin: 10px 0;
    }

    .notes {
      margin: 10px 0 0 20px;
      color: #d1d1d1;
    }

    .notes li {
      margin-bottom: 4px;
    }

    .item p {
      color: #eaeaea;
      margin: 10px 0;
    }

    .sofascore-card {
      margin: 14px 0 0;
    }

    .sofascore-card iframe {
      border: 0;
    }

    a {
      color: #ffffff;
      text-decoration: underline;
    }

    .footer {
      margin-top: 32px;
      font-size: 12px;
      color: #b3b3b3;
      line-height: 1.6;
      border-top: 1px solid #2a2a2a;
      padding-top: 18px;
    }

    .footer a {
      color: #ffffff;
    }

    @media (prefers-color-scheme: light) {
      body {
        background: #f7f7f7;
        color: #111;
      }
    }
  </style>
</head>

<body>
  <table role="presentation" class="wrapper" cellspacing="0" cellpadding="0" border="0">
    <tr>
      <td align="center">
        <table role="presentation" class="main" cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td class="content">
              <div class="brand">THE ACADEMY WATCH</div>
              <div class="title-row">
                {% if team_logo %}
                <img class="title-logo" src="{{ team_logo }}" alt="{{ team_name or 'Team' }} crest" />
                {% endif %}
                <h1>{{ title }}</h1>
              </div>
              <div class="meta">
                {% if team_name %}<span>{{ team_name }}</span>{% if range %} ¬∑ {% endif %}{% endif %}
                {% if range %}<span>{{ range[0] }} ‚Äì {{ range[1] }}</span>{% endif %}
              </div>
              <div class="divider"></div>

              {% if summary %}
              <p class="summary">{{ summary }}</p>
              {% endif %}

              {% if highlights %}
              <div class="highlights">
                <strong>Highlights</strong>
                <ul>
                  {% for h in highlights %}
                  <li>{{ h }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

              {# Headlines / Snippets Section #}
              {% if headlines_commentary %}
              <div style="margin:24px 0;">
                <div
                  style="font-size:19px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1.5px;color:#f8f8f8;font-weight:700;border-bottom:1px solid #333;padding-bottom:8px;">
                  Journalist Headlines
                </div>
                {% for article in headlines_commentary %}
                <div
                  style="background:#0a0a0a;border:1px solid #262626;border-radius:8px;padding:16px;margin-bottom:12px;">
                  <div
                    style="font-size:13px;color:#a855f7;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">
                    {{ article.type }} Commentary
                  </div>
                  <h3 style="margin:0 0 6px 0;font-size:17px;color:#ffffff;">{{ article.title }}</h3>
                  <div style="font-size:13px;color:#9ca3af;margin-bottom:10px;">by {{ article.author_name }}</div>
                  <p style="color:#d1d5db;font-size:14px;line-height:1.6;margin:0 0 12px 0;">
                    {{ article.snippet }}
                  </p>
                  <a href="{{ article.read_more_url }}" target="_blank" rel="noopener"
                    style="display:inline-block;font-size:13px;font-weight:600;color:#a855f7;text-decoration:none;">
                    Read full analysis ‚Üí
                  </a>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {# Introduction Commentary #}
              {% if intro_commentary %}
              {% for commentary in intro_commentary %}
              <div
                style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-left:4px solid #a855f7;border-radius:8px;padding:16px;margin:16px 0;">
                <div
                  style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:#d8b4fe;font-weight:600;">
                  <span style="font-size:16px;">‚úçÔ∏è</span>
                  <span>Commentary by {{ commentary.author_name }}</span>
                </div>
                <div style="color:#e5e7eb;line-height:1.7;">
                  {{ commentary.content|safe }}
                </div>
              </div>
              {% endfor %}
              {% endif %}

              {% if by_numbers %}
              <div class="highlights" style="margin-top:24px;">
                <strong>By the numbers</strong>
                <div style="margin-top:10px;color:#e6e6e6;">
                  {% if by_numbers.minutes_leaders %}
                  <p style="margin:8px 0;">
                    <strong style="color:#ffffff;">Minutes leaders:</strong>
                    {% for row in by_numbers.minutes_leaders %}
                    {{ row.player }} ({{ row.minutes }}'){% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </p>
                  {% endif %}
                  {% if by_numbers.ga_leaders %}
                  <p style="margin:8px 0;">
                    <strong style="color:#ffffff;">G+A leaders:</strong>
                    {% for row in by_numbers.ga_leaders %}
                    {{ row.player }} ({{ row.g }}G {{ row.a }}A){% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </p>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% for sec in sections %}
              <h2>{{ sec.title }}</h2>
              {% set items = [] %}
              {% if sec is mapping %}
              {% set raw_items = sec.get('items') %}
              {% elif sec and ('items' in sec) %}
              {% set raw_items = sec['items'] %}
              {% else %}
              {% set raw_items = [] %}
              {% endif %}
              {% if raw_items is iterable and raw_items is not string %}
              {% set items = raw_items %}
              {% endif %}
              {% for it in items if it is mapping %}
              <div class="item">
                <div class="item-header">
                  <div class="player-block">
                    {% if it.player_photo %}
                    <img class="player-photo" src="{{ it.player_photo }}" alt="{{ it.player_name }} headshot" />
                    {% endif %}
                    <div>
                      {% set player_link_id = it.player_api_id or it.player_id %}
                      {% if player_link_id and public_base_url %}
                      <a href="{{ public_base_url }}/players/{{ player_link_id }}" class="player" 
                         style="color:#ffffff;text-decoration:none;border-bottom:1px solid rgba(255,255,255,0.3);" 
                         target="_blank" rel="noopener">{{ it.player_name }}</a>
                      {% else %}
                      <div class="player">{{ it.player_name }}</div>
                      {% endif %}
                      <div class="loan-team">
                        {% if it.loan_team_logo %}
                        <img class="team-logo" src="{{ it.loan_team_logo }}"
                          alt="{{ (it.loan_team or it.loan_team_name) }} logo" />
                        {% endif %}
                        {% set pstatus = it.get('pathway_status', '') if it.get is defined else '' %}
                        {% if pstatus == 'first_team' %}
                        <span>{{ it.loan_team or it.loan_team_name }} (First Team)</span>
                        {% elif pstatus == 'academy' %}
                        <span>{{ it.get('current_level', 'Academy') if it.get is defined else 'Academy' }} ¬∑ {{ it.loan_team or it.loan_team_name }}</span>
                        {% else %}
                        <span>{{ it.loan_team or it.loan_team_name }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% set can_track = it.can_fetch_stats if it.can_fetch_stats is defined else True %}
                {% if can_track and it.stats is defined and it.stats is not none %}
                {% set s = it.stats or {} %}
                <div class="stats">
                  {{ s.get('minutes', 0)|int }}'
                  {# Position-specific stats (API-Football returns: Goalkeeper, Defender, Midfielder, Attacker, Forward)
                  #}
                  {% set pos = s.get('position', '') %}
                  {% if pos in ['G', 'Goalkeeper'] %}
                  {# Goalkeeper: Show saves and goals conceded #}
                  ¬∑ {{ s.get('saves', 0)|int }} Saves ¬∑ {{ s.get('goals_conceded', 0)|int }} Conceded
                  {% elif pos in ['D', 'Defender'] %}
                  {# Defender: Show tackles, interceptions, then G+A if any #}
                  {% if s.get('tackles_total') or s.get('tackles_interceptions') %}
                  ¬∑ {{ s.get('tackles_total', 0)|int }}T {{ s.get('tackles_interceptions', 0)|int }}I
                  {% endif %}
                  {% if s.get('goals', 0)|int > 0 or s.get('assists', 0)|int > 0 %}
                  ¬∑ {{ s.get('goals', 0)|int }}G {{ s.get('assists', 0)|int }}A
                  {% endif %}
                  {% elif pos in ['M', 'Midfielder'] %}
                  {# Midfielder: Show G+A and key passes #}
                  ¬∑ {{ s.get('goals', 0)|int }}G {{ s.get('assists', 0)|int }}A
                  {% if s.get('passes_key') %}
                  ¬∑ {{ s.get('passes_key', 0)|int }} Key Passes
                  {% endif %}
                  {% else %}
                  {# Forward/Attacker or unknown: Show G+A and shots #}
                  ¬∑ {{ s.get('goals', 0)|int }}G {{ s.get('assists', 0)|int }}A
                  {% if s.get('shots_total') %}
                  ¬∑ {{ s.get('shots_total', 0)|int }} Shots
                  {% endif %}
                  {% endif %}
                  {% if s.get('rating') %}
                  ¬∑ <span
                    style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:#fff;border-radius:20px;font-weight:700;font-size:14px;">‚≠ê
                    {{ "%.1f"|format(s.get('rating')|float) }}</span>
                  {% endif %}
                  {% if s.get('position') %}
                  <span
                    style="display:inline-block;padding:2px 8px;background:#e5e7eb;color:#374151;border-radius:4px;font-size:11px;font-weight:600;margin-left:6px;">{{
                    s.get('position') }}</span>
                  {% endif %}
                </div>

                {# Expanded Statistics Grid for Email #}
                {% set has_expanded_stats = s.get('shots_total') or s.get('passes_total') or s.get('tackles_total') or
                s.get('duels_total') %}
                {% if has_expanded_stats %}
                <div
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:12px 0;padding:12px;background:#f9fafb;border-radius:8px;">
                  {# Attacking Stats #}
                  {% if s.get('shots_total') or s.get('dribbles_attempts') or s.get('offsides') %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      ‚öΩ ATTACKING</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      {% if s.get('shots_total') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Shots</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('shots_total') }} ({{ s.get('shots_on', 0)
                          }} on)</span>
                      </div>
                      {% endif %}
                      {% if s.get('dribbles_attempts') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Dribbles</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('dribbles_success', 0) }}/{{
                          s.get('dribbles_attempts') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('offsides') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Offsides</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('offsides') }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}

                  {# Passing Stats #}
                  {% if s.get('passes_total') or s.get('passes_key') %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      üéØ PASSING</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      {% if s.get('passes_total') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Passes</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('passes_total') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('passes_key') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Key passes</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('passes_key') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('passes_accuracy') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Accuracy</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('passes_accuracy') }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}

                  {# Defensive Stats #}
                  {% if s.get('tackles_total') or s.get('tackles_interceptions') %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      üõ°Ô∏è DEFENDING</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      {% if s.get('tackles_total') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Tackles</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('tackles_total') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('tackles_interceptions') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Interceptions</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('tackles_interceptions') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('tackles_blocks') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Blocks</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('tackles_blocks') }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}

                  {# Duels #}
                  {% if s.get('duels_total') %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      ‚öîÔ∏è DUELS</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Won</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('duels_won', 0) }}/{{ s.get('duels_total')
                          }}</span>
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  {# Goalkeeper Stats #}
                  {% if s.get('position') in ['G', 'Goalkeeper'] and (s.get('saves') or s.get('goals_conceded')) %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      üß§ GOALKEEPER</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      {% if s.get('saves') is not none %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Saves</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('saves') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('goals_conceded') is not none %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Conceded</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('goals_conceded') }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}

                  {# Discipline #}
                  {% if s.get('fouls_committed') or s.get('fouls_drawn') or s.get('yellows', 0)|int > 0 or s.get('reds',
                  0)|int > 0 %}
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;">
                    <div
                      style="margin:0 0 6px 0;font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:600;letter-spacing:0.5px;">
                      ‚ö†Ô∏è DISCIPLINE</div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                      {% if s.get('fouls_committed') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Fouls</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('fouls_committed') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('fouls_drawn') %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Fouled</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('fouls_drawn') }}</span>
                      </div>
                      {% endif %}
                      {% if s.get('yellows', 0)|int > 0 or s.get('reds', 0)|int > 0 %}
                      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                        <span style="color:#6b7280;">Cards</span>
                        <span style="font-weight:600;color:#111827;">{{ s.get('yellows', 0)|int }}Y {{ s.get('reds',
                          0)|int }}R</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                </div>
                {% endif %}
                {% elif not can_track %}
                <div class="stats unavailable" style="color: #666; font-style: italic;">
                  ‚ÑπÔ∏è We can‚Äôt track detailed stats for this player yet.
                </div>
                {% endif %}
                {% if it.week_summary %}
                <p>{{ it.week_summary }}</p>
                {% endif %}

                {# Fixtures Section (Upcoming & Results) - Shows next week's fixtures #}
                {% if it.upcoming_fixtures and it.upcoming_fixtures|length > 0 %}
                <div
                  style="margin:14px 0;padding:12px;background:#1a1f2e;border-left:3px solid #3b82f6;border-radius:4px;">
                  <div
                    style="font-size:13px;font-weight:600;color:#60a5fa;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">
                    üìÖ Coming Up Next</div>
                  <div style="font-size:13px;color:#e5e7eb;">
                    {% for fixture in it.upcoming_fixtures %}
                    {% set is_completed = fixture.status == 'completed' and fixture.result %}
                    {% if is_completed %}
                      {% if fixture.result == 'W' %}
                        {% set border_color = '#22c55e' %}
                        {% set badge_bg = '#22c55e' %}
                      {% elif fixture.result == 'L' %}
                        {% set border_color = '#ef4444' %}
                        {% set badge_bg = '#ef4444' %}
                      {% else %}
                        {% set border_color = '#6b7280' %}
                        {% set badge_bg = '#6b7280' %}
                      {% endif %}
                    {% else %}
                      {% set border_color = '#2a3040' %}
                    {% endif %}
                    <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid {{ border_color }};{% if loop.last %}border-bottom:none;{% endif %}">
                      {% if fixture.opponent_logo %}
                      <img src="{{ fixture.opponent_logo }}" alt="{{ fixture.opponent }}" 
                           style="width:24px;height:24px;border-radius:50%;object-fit:cover;background:#1f1f1f;flex-shrink:0;" />
                      {% endif %}
                      <div style="flex:1;">
                        <div style="font-weight:600;color:#f3f4f6;">
                          {{ 'vs' if fixture.is_home else '@' }} {{ fixture.opponent }}
                          {% if is_completed %}
                          <span style="margin-left:8px;font-weight:700;">{{ fixture.team_score }}-{{ fixture.opponent_score }}</span>
                          {% endif %}
                        </div>
                        <div style="font-size:11px;color:#9ca3af;">{{ fixture.competition }}{% if fixture.date %} ‚Ä¢ {{ fixture.date[:10] }}{% endif %}</div>
                      </div>
                      {% if is_completed %}
                      <span style="background:{{ badge_bg }};color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;">{{ fixture.result }}</span>
                      {% endif %}
                    </div>
                    {% endfor %}
                    {% set has_upcoming = it.upcoming_fixtures|selectattr('status', 'undefined')|list|length > 0 or it.upcoming_fixtures|selectattr('status', 'ne', 'completed')|list|length > 0 %}
                    {% if has_upcoming %}
                    <div style="color:#9ca3af;font-size:11px;margin-top:8px;font-style:italic;">
                      Results will appear in next week's edition.
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% elif it.can_fetch_stats %}
                <div
                  style="margin:14px 0;padding:10px;background:#0f1419;border-left:3px solid #4b5563;border-radius:4px;">
                  <div style="font-size:12px;color:#9ca3af;font-style:italic;">No fixtures scheduled for the following week
                  </div>
                </div>
                {% endif %}

                {% if it.matches %}
                <div class="matches-section">
                  <div class="matches-header">‚öΩ This Week's Matches</div>
                  {% for match in it.matches %}
                  <div class="match-row">
                    {% if match.opponent_logo %}
                    <img class="opponent-logo" src="{{ match.opponent_logo }}" alt="{{ match.opponent }}" />
                    {% endif %}
                    <div class="match-info">
                      <span class="match-opponent">vs {{ match.opponent }}</span>
                      <span class="match-meta">{{ match.competition }}{% if match.home %} (H){% else %} (A){% endif %}</span>
                    </div>
                    {% if match.score %}
                    {% set home_goals = match.score.home|default(0) %}
                    {% set away_goals = match.score.away|default(0) %}
                    {% if match.result == 'W' %}
                    <span class="match-result win">{{ home_goals }}-{{ away_goals }}</span>
                    {% elif match.result == 'D' %}
                    <span class="match-result draw">{{ home_goals }}-{{ away_goals }}</span>
                    {% else %}
                    <span class="match-result loss">{{ home_goals }}-{{ away_goals }}</span>
                    {% endif %}
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
                {% elif it.match_notes %}
                <ul class="notes">
                  {% for n in it.match_notes %}
                  <li>{{ n }}</li>
                  {% endfor %}
                </ul>
                {% endif %}
                {% if it.links %}
                <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                  {% for link in it.links %}
                  {% set link_url = link if link is string else link.url %}
                  {% set link_title = link.title if link is mapping and link.title else ('Link ' ~ loop.index) %}
                  {% set is_youtube = 'youtube.com' in link_url or 'youtu.be' in link_url %}
                  {% if link_url %}
                  {% if is_youtube %}
                  <a href="{{ link_url }}" target="_blank" rel="noopener"
                    style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:6px;background:#ff0000;color:#ffffff;text-decoration:none;font-family:Arial,sans-serif;font-size:14px;font-weight:600;border:1px solid #ff0000;">
                    <i class="fab fa-youtube"
                      style="width:18px;height:18px;display:inline-block;vertical-align:middle;font-size:18px;"></i>
                    <span>{{ link_title }}</span>
                  </a>
                  {% else %}
                  <a href="{{ link_url }}" target="_blank" rel="noopener"
                    style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:6px;background:#2a2a2a;color:#ffffff;text-decoration:none;font-family:Arial,sans-serif;font-size:14px;font-weight:500;border:1px solid #3a3a3a;">
                    <span>{{ link_title }}</span>
                  </a>
                  {% endif %}
                  {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
                {% if it.rating_graph_url %}
                <div style="margin-top:12px;">
                  <img src="{{ embed_image(it.rating_graph_url) }}" alt="Rating Graph"
                    style="max-width:100%;border-radius:6px;display:block;" />
                </div>
                {% endif %}
                {% if it.minutes_graph_url %}
                <div style="margin-top:12px;">
                  <img src="{{ embed_image(it.minutes_graph_url) }}" alt="Minutes Graph"
                    style="max-width:100%;border-radius:6px;display:block;" />
                </div>
                {% endif %}
                {% if it.sofascore_player_id %}
                <div class="sofascore-card" style="margin-top:12px;">
                  <div style="font-size:14px;font-family:Arial,sans-serif;font-weight:600;margin-bottom:6px;">Sofascore
                    for {{ it.player_name or 'this player' }}</div>
                  {% if sofascore_image_template %}
                  {% set img_src = sofascore_image_template.replace('{id}', it.sofascore_player_id|string) %}
                  <a href="https://widgets.sofascore.com/embed/player/{{ it.sofascore_player_id }}?widgetTheme=dark"
                    target="_blank" rel="noopener">
                    <img src="{{ img_src }}" alt="Sofascore player chart"
                      style="max-width:320px;width:100%;height:auto;border:0;display:block;" />
                  </a>
                  <div style="font-size:12px;font-family:Arial,sans-serif;text-align:left;margin-top:6px;">
                    Player stats provided by <a target="_blank" href="https://sofascore.com/" rel="noopener"
                      style="color:#ffffff;">Sofascore</a>
                  </div>
                  {% else %}
                  <!-- fallback: many email clients block iframes; optionally set SOFASCORE_IMAGE_TEMPLATE to use an image snapshot -->
                  <a href="https://widgets.sofascore.com/embed/player/{{ it.sofascore_player_id }}?widgetTheme=dark"
                    target="_blank" rel="noopener" style="font-size:12px;">View Sofascore player card</a>
                  {% endif %}
                </div>
                {% endif %}

                {# Player Commentary #}
                {% if it.player_id and player_commentary_map and it.player_id in player_commentary_map %}
                {% for commentary in player_commentary_map[it.player_id] %}
                <div
                  style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-left:4px solid #a855f7;border-radius:8px;padding:16px;margin:12px 0 0;">
                  <div
                    style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:#d8b4fe;font-weight:600;">
                    <span style="font-size:16px;">‚úçÔ∏è</span>
                    <span>Commentary by {{ commentary.author_name }}</span>
                  </div>
                  <div style="color:#e5e7eb;line-height:1.7;">
                    {{ commentary.content|safe }}
                  </div>
                </div>
                {% endfor %}
                {% endif %}
              </div>
              {% endfor %}
              {% endfor %}

              {# Summary Commentary #}
              {% if summary_commentary %}
              {% for commentary in summary_commentary %}
              <div
                style="background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);border-left:4px solid #a855f7;border-radius:8px;padding:16px;margin:24px 0;">
                <div
                  style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:#d8b4fe;font-weight:600;">
                  <span style="font-size:16px;">‚úçÔ∏è</span>
                  <span>Commentary by {{ commentary.author_name }}</span>
                </div>
                <div style="color:#e5e7eb;line-height:1.7;">
                  {{ commentary.content|safe }}
                </div>
              </div>
              {% endfor %}
              {% endif %}

              {# Academy Update Section #}
              {% if academy_appearances %}
              <div style="margin-top:24px;">
                <div style="font-size:19px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1.5px;color:#f8f8f8;font-weight:700;border-bottom:1px solid #333;padding-bottom:8px;">
                  <span style="margin-right:8px;">üéì</span>Academy Update
                </div>
                <div style="background:#0a0a0a;border:1px solid #262626;border-radius:8px;padding:16px;">
                  <p style="color:#9ca3af;font-size:13px;margin:0 0 12px;">Youth team activity this week:</p>
                  {% for app in academy_appearances %}
                  <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #1f1f1f;{% if loop.last %}border-bottom:none;{% endif %}">
                    <div style="flex:1;">
                      <div style="font-weight:600;color:#ffffff;font-size:14px;">{{ app.player_name }}</div>
                      <div style="color:#9ca3af;font-size:12px;margin-top:2px;">
                        {{ app.home_team }} vs {{ app.away_team }}
                        {% if app.competition %} ¬∑ {{ app.competition }}{% endif %}
                      </div>
                    </div>
                    <div style="text-align:right;">
                      {% if app.started %}
                      <span style="background:#166534;color:#86efac;font-size:11px;padding:2px 6px;border-radius:3px;font-weight:600;">Started</span>
                      {% else %}
                      <span style="background:#4b5563;color:#d1d5db;font-size:11px;padding:2px 6px;border-radius:3px;font-weight:600;">Sub</span>
                      {% endif %}
                      {% if app.goals > 0 or app.assists > 0 %}
                      <div style="color:#fbbf24;font-size:13px;font-weight:700;margin-top:4px;">
                        {% if app.goals > 0 %}{{ app.goals }}G{% endif %}
                        {% if app.goals > 0 and app.assists > 0 %} {% endif %}
                        {% if app.assists > 0 %}{{ app.assists }}A{% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                  <div style="color:#6b7280;font-size:11px;margin-top:12px;font-style:italic;">
                    Youth league coverage may have limited stats availability.
                  </div>
                </div>
              </div>
              {% endif %}

              {# Community Takes Section #}
              {% if community_takes %}
              <div style="margin-top:24px;">
                <div style="font-size:19px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1.5px;color:#f8f8f8;font-weight:700;border-bottom:1px solid #333;padding-bottom:8px;">
                  Community Takes
                </div>
                {% for take in community_takes %}
                <div style="background:#0a0a0a;border:1px solid #262626;border-radius:8px;padding:14px 16px;margin-bottom:10px;">
                  <div style="display:flex;align-items:flex-start;gap:10px;">
                    <div style="font-size:20px;flex-shrink:0;">üí¨</div>
                    <div style="flex:1;">
                      <p style="color:#e5e7eb;font-size:14px;line-height:1.5;margin:0 0 8px;">
                        "{{ take.content }}"
                      </p>
                      <div style="font-size:12px;color:#9ca3af;">
                        ‚Äî {{ take.source_author }}
                        {% if take.source_platform %} on {{ take.source_platform }}{% endif %}
                        {% if take.player_name %}
                        <span style="margin-left:8px;padding:2px 6px;background:#1f2937;border-radius:3px;font-size:11px;color:#d1d5db;">
                          {{ take.player_name }}
                        </span>
                        {% endif %}
                        {% if take.source_url %}
                        <a href="{{ take.source_url }}" target="_blank" rel="noopener" style="margin-left:6px;color:#60a5fa;text-decoration:none;">‚Üó</a>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {% if fan_pulse %}
              <div class="highlights" style="margin-top:24px;">
                <strong>Fan pulse</strong>
                <ul style="margin:10px 0 0;color:#e6e6e6;">
                  {% for fp in fan_pulse %}
                  <li style="margin-bottom:8px;">
                    "{{ fp.quote }}" ‚Äî {{ fp.forum }}{% if fp.url %} (<a href="{{ fp.url }}" target="_blank"
                      rel="noopener" style="color:#ffffff;">source</a>){% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

              <div class="footer">
                {% if web_url %}
                <div
                  style="text-align:center;margin:0 0 24px;padding:16px;background:#1a1a1a;border:1px solid #303030;border-radius:8px;">
                  <p style="margin:0 0 8px;color:#ffffff;font-weight:600;font-size:15px;">Better experience on web</p>
                  <a href="{{ web_url }}" target="_blank" rel="noopener"
                    style="display:inline-block;padding:10px 20px;background:#ffffff;color:#000000;text-decoration:none;border-radius:6px;font-weight:600;font-size:14px;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
                    View full newsletter with interactive stats ‚Üí
                  </a>
                </div>
                {% endif %}

                {# Share Your Take CTA #}
                {% if submit_take_url %}
                <div style="text-align:center;margin:0 0 24px;padding:16px;background:#1e1b4b;border:1px solid #4338ca;border-radius:8px;">
                  <p style="margin:0 0 8px;color:#c4b5fd;font-weight:600;font-size:15px;">Got an opinion on a player?</p>
                  <a href="{{ submit_take_url }}" target="_blank" rel="noopener"
                    style="display:inline-block;padding:10px 20px;background:#7c3aed;color:#ffffff;text-decoration:none;border-radius:6px;font-weight:600;font-size:14px;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
                    üí¨ Share Your Take
                  </a>
                  <p style="margin:8px 0 0;font-size:12px;color:#a78bfa;">Your take could be featured in our next newsletter!</p>
                </div>
                {% endif %}

                <div class="support-cta" style="text-align:center;margin:0 0 18px;">
                  <a href="https://www.buymeacoffee.com/TheAcademyWatch" target="_blank" rel="noopener">
                    <img src="{{ bmc_button_url or 'https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png' }}" 
                         alt="Buy me a coffee" 
                         style="height:48px;border-radius:8px;" />
                  </a>
                  <div style="font-size:12px;color:#b3b3b3;margin-top:8px;">Enjoying the newsletter? A coffee keeps it
                    going.</div>
                </div>
                {% if unsubscribe_url %}
                <p>
                  If you no longer want these updates{% if team_name %} for {{ team_name }}{% endif %},
                  <a href="{{ unsubscribe_url }}" target="_blank" rel="noopener">unsubscribe instantly</a>.
                </p>
                {% if manage_url %}
                <p><a href="{{ manage_url }}" target="_blank" rel="noopener">Manage other subscription preferences</a>.
                </p>
                {% endif %}
                {% elif manage_url %}
                <p>
                  Manage or unsubscribe from future updates{% if team_name %} for {{ team_name }}{% endif %}
                  at <a href="{{ manage_url }}" target="_blank" rel="noopener">your subscription settings</a>.
                </p>
                {% endif %}
                <p style="text-align:center;">You are receiving this email because you subscribed to The Academy Watch
                  newsletters.</p>

            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>

</html>
